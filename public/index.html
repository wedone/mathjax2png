<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MathJax → PNG 转换器</title>
    <style>
        :root{--accent:#3498db;--muted:#7f8c8d;--bg:#f5f7fa;--border:#ddd;--text:#2c3e50}
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:20px}
        .card{max-width:1100px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
        .main{display:grid;grid-template-columns:1fr 420px;gap:18px}
        @media(max-width:980px){.main{grid-template-columns:1fr}}
        textarea{width:100%;height:160px;padding:10px;border:1px solid var(--border);border-radius:8px;font-family:monospace}
        .panel{background:#fff;padding:12px;border-radius:8px;border:1px solid var(--border)}
        .controls{display:flex;flex-direction:column;gap:10px}
        .row{display:flex;gap:8px;align-items:center}
        .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        .btn.secondary{background:#eef2f5;color:var(--text)}
        .url-input{flex:1;padding:8px;border:1px solid var(--border);border-radius:6px}
        .codebox{background:#f6f8fa;border:1px dashed var(--border);padding:8px;border-radius:6px;white-space:pre-wrap}
        .status{color:var(--muted);font-size:0.9rem;margin-top:8px}
        img.preview{max-width:100%;border:1px solid var(--border);border-radius:6px;background:#fff}
        .mode-switch{margin-bottom:15px;display:flex;gap:10px;justify-content:center}
        .mode-btn{padding:10px 20px;border:2px solid var(--accent);border-radius:6px;cursor:pointer;opacity:0.7}
        .mode-btn.active{background:var(--accent);color:#fff;opacity:1}
        .mixed-preview{display:flex;flex-direction:column;gap:10px}
        .mixed-preview span{line-height:1.5}
        .mixed-preview img{vertical-align:middle;margin:0 4px}
    </style>
</head>
<body>
    <div class="card">
        <h1>MathJax → PNG 转换器</h1>
        <p class="lead" style="color:var(--muted);margin-top:6px">左侧输入公式与设置；右侧预览与导出</p>

        <div class="mode-switch">
            <div class="mode-btn" data-mode="formula">公式转换</div>
            <div class="mode-btn active" data-mode="mixed">混合文本</div>
        </div>

        <div class="main" style="margin-top:14px">
            <div>
                <div class="panel">
                    <label for="formula"><strong id="input-label">输入（支持文本与公式混合，公式使用 $...$, $$...$$）</strong></label>
                    <textarea id="formula" placeholder="在此输入文本和公式...

例如：这是一个行内公式 $E=mc^2$ 和一个独立公式 $$\\frac{a}{b}$$"></textarea>
                </div>

                <div style="height:12px"></div>

                <div class="panel controls">
                    <div class="row">
                        <label>DPI</label>
                        <input id="dpi" type="number" min="50" max="1200" value="150" style="width:110px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                        <label style="margin-left:8px">Scale</label>
                        <input id="scale" type="number" min="0.1" step="0.1" value="1" style="width:80px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                    </div>

                    <div class="row">
                        <label>宽度</label>
                        <input id="width" type="number" placeholder="px" style="width:100px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                        <label style="margin-left:8px">高度</label>
                        <input id="height" type="number" placeholder="px" style="width:100px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                    </div>

                    <div class="row">
                        <label>颜色</label>
                        <input id="color" type="color" value="#000000" />
                        <label style="margin-left:8px">背景</label>
                        <input id="bgcolor" type="color" value="#ffffff" />
                        <label style="margin-left:8px">透明</label>
                        <input id="transparent" type="checkbox" checked />
                    </div>

                    <div class="row" style="margin-top:6px">
                        <button class="btn" id="previewBtn">预览</button>
                        <button class="btn" id="linkBtn">生成链接</button>
                        <button class="btn secondary" id="clearBtn" style="margin-left:auto">清空</button>
                    </div>

                    <div style="margin-top:8px" class="examples">
                        <div class="example-item" data-formula="这是文本 $E=mc^2$ 和独立公式 $$\\sum_{i=1}^n i$$" style="cursor:pointer;color:var(--accent)">示例：混合文本和公式</div>
                        <div class="example-item" data-formula="\\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}" style="cursor:pointer;color:var(--accent)">示例：二次方程解</div>
                    </div>
                </div>
            </div>

            <div>
                <div class="panel">
                    <h3 style="margin:4px 0">预览</h3>
                    <div id="resultWrap" style="min-height:120px;border:1px dashed var(--border);padding:10px;border-radius:6px;background:#fbfcfd">
                        <div style="color:var(--muted)">尚无预览</div>
                    </div>

                    <div id="linkSection" style="margin-top:12px">
                        <h3 style="margin:4px 0">图片链接</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="apiLink" type="text" readonly class="url-input" placeholder="生成的图片链接" />
                            <div style="display:flex;gap:6px">
                                <button class="btn secondary" id="copyLinkBtn">复制链接</button>
                                <button class="btn secondary" id="copyB64Btn">复制 Base64 链接</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <h3 style="margin:4px 0">导出选项</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <label for="exportFormat">格式</label>
                            <select id="exportFormat">
                                <option value="simplehtml">简单 HTML</option>
                                <option value="markdown">Markdown</option>
                                <option value="bbcode">BBCode</option>
                            </select>
                            <button class="btn secondary" id="copyFormatBtn">复制</button>
                        </div>
                        <div id="exportCode" class="codebox" style="margin-top:8px;display:none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'mixed';  // 默认为混合模式
        let lastResult = null;      // 存储最后一次转换结果

        // 获取选项值
        function getOptions() {
            return {
                dpi: document.getElementById('dpi').value,
                scale: document.getElementById('scale').value,
                width: document.getElementById('width').value || undefined,
                height: document.getElementById('height').value || undefined,
                color: document.getElementById('color').value,
                bgcolor: document.getElementById('bgcolor').value,
                transparent: document.getElementById('transparent').checked
            };
        }

        // 切换模式
        document.querySelector('.mode-switch').addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-btn')) {
                const newMode = e.target.dataset.mode;
                if (newMode === currentMode) return;

                // 更新按钮状态
                document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                // 更新模式
                currentMode = newMode;

                // 更新界面
                const inputLabel = document.getElementById('input-label');
                const formula = document.getElementById('formula');
                const linkSection = document.getElementById('linkSection');

                if (currentMode === 'formula') {
                    inputLabel.textContent = '输入（LaTeX 公式）';
                    formula.placeholder = '在此输入 LaTeX 公式...\n\n例如：E=mc^2 或 \\frac{a}{b}';
                    linkSection.style.display = 'block';
                } else {
                    inputLabel.textContent = '输入（支持文本与公式混合，公式使用 $...$, $$...$$）';
                    formula.placeholder = '在此输入文本和公式...\n\n例如：这是一个行内公式 $E=mc^2$ 和一个独立公式 $$\\frac{a}{b}$$';
                    linkSection.style.display = 'none';
                }

                // 清空预览
                document.getElementById('resultWrap').innerHTML = '<div style="color:var(--muted)">尚无预览</div>';
                document.getElementById('apiLink').value = '';
            }
        });

        // 预览
        document.getElementById('previewBtn').addEventListener('click', async () => {
            const content = document.getElementById('formula').value;
            if (!content) return;

            const options = getOptions();
            const api = currentMode === 'formula' ? '/convert' : '/convert-mixed';
            const body = currentMode === 'formula' 
                ? { formula: content, options } 
                : { content, options };

            try {
                const res = await fetch(api, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('转换失败');
                const result = await res.json();
                lastResult = result;

                const resultWrap = document.getElementById('resultWrap');
                
                if (currentMode === 'formula') {
                    // 单个公式模式
                    resultWrap.innerHTML = `<img src="${result.url}" class="preview" alt="公式预览" />`;
                    document.getElementById('apiLink').value = window.location.origin + result.url;
                } else {
                    // 混合模式
                    resultWrap.innerHTML = '';
                    const container = document.createElement('div');
                    container.className = 'mixed-preview';
                    
                    result.parts.forEach(part => {
                        if (part.type === 'text') {
                            const span = document.createElement('span');
                            span.textContent = part.content;
                            container.appendChild(span);
                        } else {
                            const img = document.createElement('img');
                            img.src = part.url;
                            img.alt = part.content;
                            img.className = 'preview';
                            container.appendChild(img);
                        }
                    });
                    
                    resultWrap.appendChild(container);
                }
            } catch (err) {
                document.getElementById('resultWrap').innerHTML = '<div style="color:red">转换失败</div>';
                console.error('Error:', err);
            }
        });

        // 生成链接
        document.getElementById('linkBtn').addEventListener('click', async () => {
            if (currentMode !== 'formula') return;
            
            const formula = document.getElementById('formula').value;
            if (!formula) return;

            try {
                const res = await fetch('/png', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        formula,
                        options: getOptions()
                    })
                });

                if (!res.ok) throw new Error('Failed to generate');
                
                // 直接在新窗口打开图片
                window.open(res.url, '_blank');
            } catch (err) {
                console.error('Error:', err);
            }
        });

        // 复制链接
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const link = document.getElementById('apiLink').value;
            if (link) {
                navigator.clipboard.writeText(link);
                alert('链接已复制到剪贴板');
            }
        });

        // 复制 Base64 链接
        document.getElementById('copyB64Btn').addEventListener('click', async () => {
            if (currentMode !== 'formula') return;
            
            const formula = document.getElementById('formula').value;
            if (!formula) return;

            const b64 = btoa(formula).replace(/\+/g, '-').replace(/\//g, '_');
            const options = new URLSearchParams(getOptions()).toString();
            const url = `${window.location.origin}/png/b64/${b64}${options ? '?' + options : ''}`;
            
            try {
                await navigator.clipboard.writeText(url);
                alert('Base64 链接已复制到剪贴板');
            } catch (err) {
                console.error('Error:', err);
            }
        });

        // 清空
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('formula').value = '';
            document.getElementById('resultWrap').innerHTML = '<div style="color:var(--muted)">尚无预览</div>';
            document.getElementById('apiLink').value = '';
            lastResult = null;
        });

        // 示例
        document.querySelectorAll('.example-item').forEach(item => {
            item.addEventListener('click', () => {
                document.getElementById('formula').value = item.dataset.formula;
            });
        });
        
        // 导出格式切换
        document.getElementById('exportFormat').addEventListener('change', () => {
            if (!lastResult) return;
            const format = document.getElementById('exportFormat').value;
            const exportCode = document.getElementById('exportCode');
            
            if (currentMode === 'formula') {
                const imgUrl = document.getElementById('apiLink').value;
                let code = '';
                
                switch (format) {
                    case 'simplehtml':
                        code = `<img src="${imgUrl}" alt="数学公式" />`;
                        break;
                    case 'markdown':
                        code = `![数学公式](${imgUrl})`;
                        break;
                    case 'bbcode':
                        code = `[img]${imgUrl}[/img]`;
                        break;
                }
                
                exportCode.textContent = code;
                exportCode.style.display = 'block';
            } else {
                // 混合模式的导出
                const parts = lastResult.parts;
                let code = '';
                
                switch (format) {
                    case 'simplehtml':
                        code = parts.map(part => 
                            part.type === 'text' 
                                ? part.content 
                                : `<img src="${part.url}" alt="${part.content}" />`
                        ).join('');
                        break;
                    case 'markdown':
                        code = parts.map(part => 
                            part.type === 'text' 
                                ? part.content 
                                : `![${part.content}](${part.url})`
                        ).join('');
                        break;
                    case 'bbcode':
                        code = parts.map(part => 
                            part.type === 'text' 
                                ? part.content 
                                : `[img]${part.url}[/img]`
                        ).join('');
                        break;
                }
                
                exportCode.textContent = code;
                exportCode.style.display = 'block';
            }
        });

        // 复制导出格式
        document.getElementById('copyFormatBtn').addEventListener('click', () => {
            const code = document.getElementById('exportCode').textContent;
            if (code) {
                navigator.clipboard.writeText(code);
                alert('已复制到剪贴板');
            }
        });

        // 禁用浏览器默认的拖放行为
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());
    </script>
</body>
</html>