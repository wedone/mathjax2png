<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MathJax → PNG 转换器</title>
    <style>
        :root{--accent:#3498db;--muted:#7f8c8d;--bg:#f5f7fa;--border:#ddd;--text:#2c3e50}
        *{box-sizing:border-box}
        body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text);padding:20px}
        .card{max-width:1100px;margin:0 auto;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
        .main{display:grid;grid-template-columns:1fr 420px;gap:18px}
        @media(max-width:980px){.main{grid-template-columns:1fr}}
        textarea{width:100%;height:160px;padding:10px;border:1px solid var(--border);border-radius:8px;font-family:monospace}
        .panel{background:#fff;padding:12px;border-radius:8px;border:1px solid var(--border)}
        .controls{display:flex;flex-direction:column;gap:10px}
        .row{display:flex;gap:8px;align-items:center}
        .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
        .btn.secondary{background:#eef2f5;color:var(--text)}
        .url-input{flex:1;padding:8px;border:1px solid var(--border);border-radius:6px}
        .codebox{background:#f6f8fa;border:1px dashed var(--border);padding:8px;border-radius:6px;white-space:pre-wrap}
        .status{color:var(--muted);font-size:0.9rem;margin-top:8px}
        img.preview{max-width:100%;border:1px solid var(--border);border-radius:6px;background:#fff}
    </style>
</head>
<body>
    <div class="card">
        <h1>MathJax → PNG 转换器</h1>
        <p class="lead" style="color:var(--muted);margin-top:6px">左侧输入公式与设置；右侧预览与导出</p>

        <div class="main" style="margin-top:14px">
            <div>
                <div class="panel">
                    <label for="formula"><strong>输入（支持 $...$, $$...$$, \(...\), \[...\]）</strong></label>
                    <textarea id="formula" placeholder="在此输入 TeX / 混合文本..."></textarea>
                </div>

                <div style="height:12px"></div>

                <div class="panel controls">
                    <div class="row">
                        <label>DPI</label>
                        <input id="dpi" type="number" min="50" max="1200" value="150" style="width:110px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                        <label style="margin-left:8px">Scale</label>
                        <input id="scale" type="number" min="0.1" step="0.1" value="1" style="width:80px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                    </div>

                    <div class="row">
                        <label>宽度</label>
                        <input id="width" type="number" placeholder="px" style="width:100px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                        <label style="margin-left:8px">高度</label>
                        <input id="height" type="number" placeholder="px" style="width:100px;padding:6px;border:1px solid var(--border);border-radius:6px" />
                    </div>

                    <div class="row">
                        <label>颜色</label>
                        <input id="color" type="color" value="#000000" />
                        <label style="margin-left:8px">背景</label>
                        <input id="bgcolor" type="color" value="#ffffff" />
                        <label style="margin-left:8px">透明</label>
                        <input id="transparent" type="checkbox" />
                    </div>

                    <div class="row" style="margin-top:6px">
                        <button class="btn" id="previewBtn">预览</button>
                        <button class="btn" id="linkBtn">生成链接</button>
                        <button class="btn secondary" id="clearBtn" style="margin-left:auto">清空</button>
                    </div>

                    <div style="margin-top:8px" class="examples">
                        <div class="example-item" data-formula="E=mc^2" style="cursor:pointer;color:var(--accent)">示例：E=mc^2</div>
                        <div class="example-item" data-formula="\\frac{a}{b}" style="cursor:pointer;color:var(--accent)">示例：\\frac{a}{b}</div>
                    </div>
                </div>
            </div>

            <div>
                <div class="panel">
                    <h3 style="margin:4px 0">预览</h3>
                    <div id="resultWrap" style="min-height:120px;border:1px dashed var(--border);padding:10px;border-radius:6px;background:#fbfcfd">
                        <div style="color:var(--muted)">尚无预览</div>
                    </div>

                    <div style="margin-top:12px">
                        <h3 style="margin:4px 0">图片链接</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="apiLink" type="text" readonly class="url-input" placeholder="生成的图片链接" />
                            <div style="display:flex;gap:6px">
                                <button class="btn secondary" id="copyLinkBtn">复制链接</button>
                                <button class="btn secondary" id="copyB64Btn">复制 Base64 链接</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:12px">
                        <h3 style="margin:4px 0">导出选项</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <label for="exportFormat">格式</label>
                            <select id="exportFormat">
                                <option value="simplehtml">简单 HTML</option>
                                <option value="markdown">Markdown</option>
                            </select>
                            <div style="margin-left:auto;display:flex;gap:8px">
                                <button class="btn" id="downloadBtn">下载 PNG</button>
                                <button class="btn secondary" id="embedBtn">复制嵌入代码</button>
                            </div>
                        </div>
                        <div id="embedBox" style="margin-top:8px">
                            <div class="codebox" id="embedCode" style="display:none"></div>
                        </div>
                    </div>

                    <div class="status" id="status">就绪</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const $ = id => document.getElementById(id);
            const setStatus = s => { const el = $('status'); if(el) el.textContent = s; };

            function collectOptions(){
                const dpi = Number($('dpi')?.value) || undefined;
                const scale = Number($('scale')?.value) || undefined;
                const width = Number($('width')?.value) || undefined;
                const height = Number($('height')?.value) || undefined;
                const color = $('color')?.value || undefined;
                const bgcolor = $('bgcolor')?.value || undefined;
                const transparent = !!$('transparent')?.checked;
                const opts = { dpi, scale, width, height, color, bgcolor, transparent };
                Object.keys(opts).forEach(k=>opts[k]===undefined && delete opts[k]);
                return opts;
            }

            function validateFormula(formula){
                const errors = [];
                if(!formula || !String(formula).trim()){ errors.push('公式为空'); return { ok:false, errors }; }
                let depth = 0;
                for(let i=0;i<formula.length;i++){ const ch = formula[i]; if(ch==='{') depth++; else if(ch==='}') { depth--; if(depth<0){ errors.push("多余右括号 '}'"); break; } } }
                if(depth>0) errors.push('检测到未闭合的大括号');
                const dollar = (String(formula).match(/\$/g)||[]).length; if(dollar%2===1) errors.push('检测到不配对的 $');
                return { ok: errors.length===0, errors, longWarn: formula.length>1200 };
            }

            async function previewPNG(){
                const ta = $('formula'); const formula = ta ? ta.value : '';
                const v = validateFormula(formula); if(!v.ok){ setStatus('公式校验失败: '+v.errors.join('；')); return; }
                setStatus('渲染中...');
                const opts = collectOptions();
                try{
                    const res = await fetch('/png', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ formula, options: opts }) });
                    if(!res.ok) throw new Error('渲染失败');
                    const buf = await res.arrayBuffer(); const blob = new Blob([buf],{type:'image/png'}); const url = URL.createObjectURL(blob);
                    const wrap = $('resultWrap'); if(wrap) wrap.innerHTML = `<img class="preview" id="resultImg" src="${url}" alt="preview"/>`;
                    if($('apiLink')) $('apiLink').value = '';
                    setStatus('渲染完成');
                }catch(err){ console.error(err); setStatus('渲染失败'); }
            }

            function generateLink(){
                const ta = $('formula'); const formula = ta ? ta.value : '';
                const v = validateFormula(formula); if(!v.ok){ setStatus('公式校验失败: '+v.errors.join('；')); return; }
                setStatus('生成链接中...');
                const opts = collectOptions();
                try{
                    const qp = new URLSearchParams(); qp.set('formula', formula);
                    Object.entries(opts).forEach(([k,v])=>{ if(v!==undefined) qp.set(k,String(v)); });
                    const getLink = `${location.origin}/png?${qp.toString()}`;
                    const b64 = btoa(unescape(encodeURIComponent(formula))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
                    const b64Link = `${location.origin}/png/b64/${b64}`;
                    if($('apiLink')) $('apiLink').value = getLink;
                    const wrap = $('resultWrap'); if(wrap) wrap.innerHTML = `<img class="preview" id="resultImg" src="${getLink}" alt="preview"/>`;
                    setStatus('已生成链接');
                }catch(e){ console.error(e); setStatus('生成失败'); }
            }

            // event bindings
            const previewBtn = $('previewBtn'); const linkBtn = $('linkBtn'); const clearBtn = $('clearBtn');
            previewBtn && previewBtn.addEventListener('click', previewPNG);
            linkBtn && linkBtn.addEventListener('click', generateLink);
            clearBtn && clearBtn.addEventListener('click', ()=>{ if($('formula')) $('formula').value=''; const wrap=$('resultWrap'); if(wrap) wrap.innerHTML='<div style="color:var(--muted)">尚无预览</div>'; if($('apiLink')) $('apiLink').value=''; setStatus('已清除'); });

            document.addEventListener('click', (e)=>{
                const t = e.target;
                if(t && t.classList && t.classList.contains('example-item')){
                    const f = t.dataset.formula || t.textContent || '';
                    if($('formula')) $('formula').value = f; setStatus('已插入示例公式');
                }
            });

            const copyLinkBtn = $('copyLinkBtn'); copyLinkBtn && copyLinkBtn.addEventListener('click', ()=>{ const v = $('apiLink')?.value; if(!v){ setStatus('无链接可复制'); return; } navigator.clipboard.writeText(v).then(()=>setStatus('已复制链接')).catch(()=>setStatus('复制失败')); });
            const copyB64Btn = $('copyB64Btn'); copyB64Btn && copyB64Btn.addEventListener('click', ()=>{ const formula = $('formula')?.value || ''; if(!formula.trim()){ setStatus('没有公式可编码'); return; } const b = btoa(unescape(encodeURIComponent(formula))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); const link = `${location.origin}/png/b64/${b}`; navigator.clipboard.writeText(link).then(()=>setStatus('已复制 base64 链接')).catch(()=>setStatus('复制失败')); });

            const downloadBtn = $('downloadBtn'); downloadBtn && downloadBtn.addEventListener('click', ()=>{
                const img = $('resultImg'); if(!img || !img.src){ setStatus('没有可下载的图片'); return; }
                const a = document.createElement('a'); a.href = img.src; a.download = 'formula.png'; document.body.appendChild(a); a.click(); a.remove(); setStatus('下载完成');
            });

            const embedBtn = $('embedBtn'); embedBtn && embedBtn.addEventListener('click', ()=>{
                const format = $('exportFormat')?.value || 'simplehtml'; const wrap = $('resultWrap'); const html = wrap ? wrap.innerHTML : '';
                if(!html){ setStatus('无内容可导出'); return; }
                if(format === 'markdown'){
                    const m = html.match(/<img[^>]+src\s*=\s*"([^"]+)"/i);
                    const md = m ? `![](${m[1]})` : html.replace(/<[^>]+>/g,'');
                    const code = $('embedCode'); if(code){ code.textContent = md; code.style.display='block'; }
                    navigator.clipboard.writeText(md).then(()=>setStatus('已复制嵌入代码')).catch(()=>setStatus('复制失败'));
                } else {
                    const simple = html.replace(/\s*style=\"[^\"]*\"/g,''); const code = $('embedCode'); if(code){ code.textContent = simple; code.style.display='block'; }
                    navigator.clipboard.writeText(simple).then(()=>setStatus('已复制嵌入代码')).catch(()=>setStatus('复制失败'));
                }
            });

            setStatus('就绪');
        });
    </script>
</body>
</html>